<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cardano Web Snek</title>
    <link rel="stylesheet" href="/static/css/output.min.css" />
    <script src="/static/js/web-snek.js"></script>
    <script src="https://unpkg.com/htmx.org@1.9.9"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.8/clipboard.min.js"></script>
  </head>

  <body
    class="min-h-screen bg-gradient-radial from-blue-700 via-blue-900 to-black"
  >
    <!-- Touch the Snek -->
    <button
      class="relative top-4 left-1/2 transform -translate-x-1/2 bg-transparent text-white px-4 py-2 rounded"
      id="toggleButton"
    >
      <img
        src="/static/images/snek-illustration.png"
        alt="Snek Menu"
        class="w-20 focus:outline-none"
        tabindex="-1"
      />
    </button>
    <div class="mx-auto sm:px-6 lg:px-8">
      <div class="mx-auto text-center mb-4 px-2">
        <input
          type="text"
          id="nodeAddressInput"
          onfocus="this.select();"
          class="form-input rounded-md border-b text-center border-white bg-transparent text-white focus:outline-none lg:w-1/3 md:w-2/3 w-full"
          onkeydown="if(event.key==='Enter') updateNodeAddress();"
          autocomplete="web-snek"
        />
      </div>

      <div id="messages-container" class="overflow-auto px-1 zoom-in">
        <!-- Dynamic message blocks will be inserted here -->
      </div>
    </div>

    <button
      id="toTop"
      class="hidden fixed bottom-0 right-12 bg-transparent px-4 py-2 rounded transition-opacity animate-bounce"
    >
      <img
        src="/static/images/snek-illustration.png"
        alt="Up"
        class="w-14 focus:outline-none"
        tabindex="-1"
        onclick="goToTop()"
      />
    </button>

    <!-- Off-canvas Menu -->
    <div
      class="offcanvas fixed left-0 right-0 rounded-lg bottom-0 bg-opacity-10 backdrop-blur-sm transform translate-y-full overflow-y-auto"
    >
      <!-- Close Button -->
      <button class="absolute top-4 right-4" id="closeButton">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke="white"
          class="h-6 w-6"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M6 18L18 6M6 6l12 12"
          />
        </svg>
      </button>

      <!-- Menu Content -->

      <div class="container mx-auto">
        <div class="grid grid-cols-1 mb-6 md:grid-cols-1 lg:grid-cols-1">
          <div>
            <h1 class="text-white">Snek Skin Menu</h1>
          </div>

          <div class="flex justify-center bg-transparent py-6">
            <span class="isolate inline-flex rounded-md shadow-sm">
              <button
                value="chainsync.block"
                onclick="updateEventType('chainsync.block')"
                type="button"
                class="relative inline-flex items-center rounded-l-md bg-transparent px-3 py-2 text-sm font-semibold text-white hover:text-gray-200 active:text-gray-400 ring-1 ring-inset ring-gray-300 focus:z-10"
              >
                Block
              </button>
              <button
                value="chainsync.transaction"
                onclick="updateEventType('chainsync.transaction')"
                type="button"
                class="relative -ml-px inline-flex items-center bg-transparent px-3 py-2 text-sm font-semibold text-white ring-1 hover:text-gray-200 active:text-gray-400 ring-inset ring-gray-300 focus:z-10"
              >
                Transaction
              </button>
              <button
                value="chainsync.rollback"
                onclick="updateEventType('chainsync.rollback')"
                type="button"
                class="relative -ml-px inline-flex items-center rounded-r-md bg-transparent px-3 py-2 text-sm font-semibold text-white hover:text-gray-200 active:text-gray-400 ring-1 ring-inset ring-gray-300 focus:z-10"
              >
                Rollback
              </button>
            </span>
          </div>

          <div class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-2">
            <div
              class="flex justify-center rounded-lg border-2 border-white bg-transparent py-6"
            >
              <div class="mb-2 flex items-center">
                <!-- Checkbox -->
                <label class="inline-flex items-center">
                  <input type="checkbox" class="form-checkbox rounded-lg" />
                  <span class="mx-4 text-white"></span>
                </label>
                <!-- Input field -->
                <input
                  type="text"
                  class="form-input ml-2 w-full rounded-lg border-b border-white bg-transparent text-white focus:outline-none"
                />
              </div>
            </div>

            <div
              class="flex justify-center rounded-xl border-2 border-gray-300 bg-transparent p-6"
            >
              <div class="mb-2 flex items-center">
                <!-- Checkbox -->
                <label class="inline-flex items-center">
                  <input type="checkbox" class="form-checkbox rounded-lg" />
                  <span class="mx-4 text-white"></span>
                </label>
                <!-- Input field -->
                <input
                  type="text"
                  class="form-input ml-2 w-full rounded-lg border-b border-white bg-transparent text-white focus:outline-none"
                />
              </div>
            </div>
            <div
              class="flex justify-center rounded-xl border-2 border-gray-300 bg-transparent p-6"
            >
              <div class="mb-2 flex items-center">
                <!-- Checkbox -->
                <label class="inline-flex items-center">
                  <input type="checkbox" class="form-checkbox rounded-lg" />
                  <span class="mx-4 text-white"></span>
                </label>
                <!-- Input field -->
                <input
                  type="text"
                  class="form-input ml-2 w-full rounded-lg border-b border-white bg-transparent text-white focus:outline-none"
                />
              </div>
            </div>

            <div
              class="flex justify-center rounded-xl border-2 border-gray-300 bg-transparent p-6"
            >
              <div class="mb-2 flex items-center">
                <!-- Checkbox -->
                <label class="inline-flex items-center">
                  <input type="checkbox" class="form-checkbox rounded-lg" />
                  <span class="mx-4 text-white"></span>
                </label>
                <!-- Input field -->
                <input
                  type="text"
                  class="form-input ml-2 w-full rounded-lg border-b border-white bg-transparent text-white focus:outline-none"
                />
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script>
    let prevSlotNumber;
    let inExtraDataView = false;
    let eventsMap = new Map();
    let messageIdCounter = 0;
    var socket = new WebSocket("ws://localhost:8080/ws");

    const messagesContainer = document.getElementById("messages-container");

    // Function to create a new message div with a unique id
    function createMessageDiv() {
      const newDiv = document.createElement("div");
      newDiv.classList.add("message-block");
      return newDiv;
    }

    // Function to clear the screen
    function clearScreen() {
      const messagesContainer = document.getElementById("messages-container");
      messagesContainer.innerHTML = "";
    }

    // Function to handle WebSocket open event
    function handleSocketOpen(event) {
      console.log("WebSocket connection opened:", event);
    }

    // Function to handle WebSocket error event
    function handleSocketError(event) {
      console.error("WebSocket error:", event);
    }

    // Function to handle WebSocket close event
    function handleSocketClose(event) {
      console.log("WebSocket connection closed:", event);
    }

    // Function to handle WebSocket message event
    function handleSocketMessage(event) {
      const eventData = JSON.parse(event.data);

      // If inExtraDataView is true, don't display the event
      if (inExtraDataView) return;

      // Get or create the div for the event
      const { newDiv } = eventsMap.get(eventData?.context?.transactionHash) || {
        newDiv: createMessageDiv(),
      };

      // Check if eventData is defined before displaying the event
      if (eventData) {
        // Display the event
        displayEvent(eventData, newDiv);

        // Update the map only if the event is not already in the map
        if (!eventsMap.has(eventData.context.transactionHash)) {
          eventsMap.set(eventData.context.transactionHash, {
            eventData,
            newDiv,
          });
        }
      }
    }

    // Function to handle left arrow click (Go Back)
    function goBack() {
      // Reset the view state to "main page" view only if inExtraDataView is true
      inExtraDataView = false;

      // Clear the screen
      clearScreen();

      // Display all events from the map in the messages container
      eventsMap.forEach(({ eventData, newDiv }) => {
        displayEvent(eventData, newDiv);
        messagesContainer.prepend(newDiv); // Prepend the new div to the container
      });

      removeGoBackButton(); // Remove the "Go Back" button
    }

    // Function to remove the "Go Back" button
    function removeGoBackButton() {
      const goBackButton = document.getElementById("goBackButton");
      if (goBackButton) {
        goBackButton.parentNode.removeChild(goBackButton);
      }
    }

    function displayEvent(eventData) {
      const newDiv = createMessageDiv();
      switch (eventData.type) {
        case "chainsync.block":
          displayBlockEvent(eventData, newDiv);
          break;
        case "chainsync.rollback":
          displayRollbackEvent(eventData, newDiv);
          break;
        case "chainsync.transaction":
          // Check if inExtraDataView is false before displaying transaction events
          if (!inExtraDataView) {
            displayTransactionEvent(eventData, newDiv);
          }
          break;
        default:
          console.log("Unknown event type:", eventData.type);
      }
      // Prepend the new div to the provided container
      messagesContainer.prepend(newDiv);
    }

    // Function to display TransactionEvent
    function displayTransactionEvent(transactionEvent, newDiv) {
      const transactionDiv = document.createElement("div");
      transactionDiv.classList.add("my-2");

      // Calculate time difference
      const timeDifference = calculateTimeDifference(transactionEvent);
      displayedTimeDifference = timeDifference; // Store the displayed time difference

      // Dynamically create the link for each transaction
      const txLink = document.createElement("a");
      const transactionHash = transactionEvent.context.transactionHash;
      const linkId = `tx-link-${transactionHash}`;
      txLink.href = `#${linkId}`;
      txLink.id = linkId;

      transactionDiv.innerHTML = `
    <div class="zoom-in mx-auto max-w-5xl px-4 sm:px-6 lg:px-8 bg-black p-6 rounded-lg shadow-lg relative">
      <div class="mt-2">
        ${txLink.outerHTML}
      </div>
      <pre class="mx-auto whitespace-pre-line text-yellow-600">
        <span class="text-blue-400">Type</span><span class="text-white">:</span> ${transactionEvent.type}
        <span class="text-blue-400">Timestamp</span><span class="text-white">:</span> ${transactionEvent.timestamp}
        <span class="text-blue-400">Block</span><span class="text-white">:</span> ${transactionEvent.context.blockNumber}
        <span class="text-blue-400">Slot</span><span class="text-white">:</span> ${transactionEvent.context.slotNumber}
        <span class="text-blue-400">Tx Hash</span><span class="text-white">:</span> <span class="whitespace-pre-line text-wrap" 
          id="txHash" onclick="copyToClipboard(this)">${transactionEvent.context.transactionHash}</span>
        <span class="text-blue-400">Tx Fee</span><span class="text-white">:</span> ${transactionEvent.payload.fee}
      </pre>
      <div class="absolute top-1 right-1 cursor-pointer" id="arrowButton">
        ➡️ <!-- Right arrow symbol -->
      </div>
    </div>
  `;

      // Check if the block number has increased
      if (timeDifference !== "") {
        const timeDifferenceDiv = document.createElement("div");
        timeDifferenceDiv.classList.add("text-center", "text-white");
        timeDifferenceDiv.textContent = timeDifference;
        transactionDiv.appendChild(timeDifferenceDiv);
      }

      // Add event listener for arrow button click
      const arrowButton = transactionDiv.querySelector("#arrowButton");
      arrowButton.addEventListener("click", () =>
        handleRightArrowClick(transactionEvent)
      );

      // Append the new div to the provided container
      newDiv.appendChild(transactionDiv);
    }

    // Function to handle right arrow click
    function handleRightArrowClick(transactionEvent) {
      // Store the current scroll position
      const currentScrollPosition = window.scrollY;
      // Set the view state to "extra data" view
      inExtraDataView = true;
      // Clear the screen
      clearScreen();
      // Display extra data
      displayExtraData(transactionEvent);
      // Scroll to the top of the page
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    // Function to display extra data
    function displayExtraData(transactionEvent) {
      // Create a new div for the extra data and left arrow
      const extraDataDiv = document.createElement("div");
      extraDataDiv.classList.add(
        "zoom-in",
        "mx-auto",
        "max-w-5xl",
        "px-4",
        "sm:px-6",
        "lg:px-8",
        "bg-black",
        "p-6",
        "rounded-lg",
        "shadow-lg",
        "relative"
      );

      // Logic to extract and display the extra data goes here
      const extraData = extractExtraData(transactionEvent);
      extraDataDiv.innerHTML = `
    <pre class="mx-auto whitespace-pre-line text-white">
      ${extraData}
    </pre>
  `;

      // Append the left arrow to the extra data div
      const leftArrowDiv = document.createElement("div");
      leftArrowDiv.classList.add(
        "absolute",
        "top-0", // Adjusted to top-0 for top corner
        "left-0", // Adjusted to left-0 for left corner
        "cursor-pointer",
        "text-white",
        "text-2xl"
      );
      leftArrowDiv.innerHTML = "⬅️"; // Left arrow symbol
      // Add an event listener to handle left arrow click
      leftArrowDiv.addEventListener("click", () => {
        // Go back to the main view
        goBack();
      });
      // Append the left arrow to the extra data div
      extraDataDiv.appendChild(leftArrowDiv);
      // Append the extra data div to the messages container
      const messagesContainer = document.getElementById("messages-container");
      messagesContainer.appendChild(extraDataDiv);
    }

// Function to extract and format the extra data
function extractExtraData(transactionEvent) {
  const data = transactionEvent.payload;

  return `
    <div class="zoom-in mx-auto max-w-5xl px-4 sm:px-6 lg:px-8 bg-black p-6 rounded-lg shadow-lg relative">
      <pre class="mx-auto whitespace-pre-line text-white">
        <span class="text-blue-400">Block Hash:</span> <span class="text-yellow-600" onclick="copyToClipboard(this, 'blockHash')" style="word-wrap: break-word;">${data.blockHash}</span>
        <span class="text-blue-400">Transaction CBOR:</span> ${data.transactionCbor ? `<span class="text-white" style="word-wrap: break-word;">${data.transactionCbor}</span>` : '<span class="text-gray-400">Not available</span>'}        
        <span class="text-blue-400">Inputs:</span>
        ${data.inputs.map((input, index) => `<div key="${index}" class="ml-2"><span class="text-white" style="word-wrap: break-word;">${input}</span></div>`).join('')}
        <span class="text-blue-400">Outputs:</span>
        ${data.outputs.map((output, index) => `
          <div key="${index}" class="ml-2">
            <span class="text-blue-400">Address:</span> <span class="text-yellow-600" onclick="copyToClipboard(this, 'address')" style="word-wrap: break-word;">${output.address}</span>
            <span class="text-blue-400">Amount:</span> <span class="text-white">${output.amount}</span>
          </div>`).join('')}
        <span class="text-blue-400">Metadata:</span> ${data.metadata ? `<span class="text-white" style="word-wrap: break-word;">${data.metadata}</span>` : '<span class="text-gray-400">Not available</span>'}
        <span class="text-blue-400">Fee:</span> <span class="text-white">${data.fee}</span>
        <span class="text-blue-400">TTL:</span> <span class="text-white">${data.ttl}</span>
      </pre>
    </div>
  `;
}


    // Set up WebSocket event listeners
    socket.addEventListener("open", handleSocketOpen);
    socket.addEventListener("error", handleSocketError);
    socket.addEventListener("close", handleSocketClose);
    socket.addEventListener("message", handleSocketMessage);
  </script>
</html>
